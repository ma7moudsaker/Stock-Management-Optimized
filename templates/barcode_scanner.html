{% extends "base.html" %}
{% block title %}Barcode Scanner - Stock Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-camera"></i> Barcode Scanner</h2>
            <p class="text-muted mb-0">Scan barcodes to update inventory</p>
        </div>
    </div>

    <!-- Session Control -->
    <div class="card mb-4" id="sessionControl">
        <div class="card-body">
            <h5 class="card-title mb-3"><i class="fas fa-play-circle"></i> Session Control</h5>

            {% if not active_session.exists %}
            <!-- Start New Session -->
            <div id="startSessionSection">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Select Mode:</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="sessionMode" id="modeAdd" value="add" checked>
                            <label class="btn btn-outline-success" for="modeAdd">
                                <i class="fas fa-plus-circle"></i> Add Stock
                            </label>

                            <input type="radio" class="btn-check" name="sessionMode" id="modeRemove" value="remove">
                            <label class="btn btn-outline-danger" for="modeRemove">
                                <i class="fas fa-minus-circle"></i> Remove Stock
                            </label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary btn-lg" id="startSessionBtn">
                    <i class="fas fa-play"></i> Start New Session
                </button>
            </div>
            {% else %}
            <!-- Active Session Info -->
            <div id="activeSessionSection">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Active Session:</strong>
                    <span class="badge bg-{{ 'success' if active_session.mode == 'add' else 'danger' }}">
                        {{ active_session.mode.upper() }} MODE
                    </span>
                    | Started: {{ active_session.created_at }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Scanner Input (Hidden until session starts) -->
    <div class="card mb-4 {% if not active_session.exists %}d-none{% endif %}" id="scannerSection">
        <div class="card-body">
            <h5 class="card-title mb-3"><i class="fas fa-barcode"></i> Scan Barcode</h5>

            <!-- Camera Scanner Button -->
            <div class="mb-4">
                <button class="btn btn-primary btn-lg w-100" id="startCameraBtn" style="padding: 20px;">
                    <i class="fas fa-camera" style="font-size: 1.5em;"></i>
                    <br>
                    <strong style="font-size: 1.2em;">START CAMERA SCANNER</strong>
                </button>
            </div>

            <!-- Manual/USB Input -->
            <div class="mt-4">
                <label class="form-label"><strong>Or Enter Manually / USB Scanner:</strong></label>
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control" id="barcodeInput"
                        placeholder="Type or scan barcode here...">
                    <button class="btn btn-success" id="scanBtn">
                        <i class="fas fa-search"></i> Scan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanned Items Table (Hidden until session has items) -->
    <div class="card mb-4 {% if not active_session.exists or not active_session.items %}d-none{% endif %}"
        id="itemsSection">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> Scanned Items</h5>
            <span id="sessionModeIndicator" class="badge bg-success">ADD MODE</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="itemsTable">
                    <thead>
                        <tr>
                            <th style="width: 50px">#</th>
                            <th style="width: 80px">Image</th>
                            <th>Code</th>
                            <th>Brand</th>
                            <th style="width: 120px">Quantity</th> <!-- ‚úÖ ÿßÿ™ÿ≠ÿ±ŸÉÿ™ ŸáŸÜÿß -->
                            <th>Color</th>
                            <th style="width: 100px">Stock</th>
                            <th style="width: 80px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Items will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Summary -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <h5>Summary:</h5>
                    <p class="mb-1">
                        <strong>Total Items:</strong>
                        <span id="totalItems" class="badge bg-primary">0</span>
                    </p>
                    <p class="mb-0">
                        <strong>Total Quantity:</strong>
                        <span id="totalQuantity" class="badge bg-info">0</span>
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4">
                <button class="btn btn-success btn-lg me-2" id="confirmBtn">
                    <i class="fas fa-check"></i> Confirm & Update Stock
                </button>
                <button class="btn btn-danger btn-lg me-2" id="cancelBtn">
                    <i class="fas fa-times"></i> Cancel Session
                </button>
                <button class="btn btn-warning btn-lg" id="clearBtn">
                    <i class="fas fa-trash"></i> Clear All Items
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card {% if not active_session.exists %}d-none{% endif %}" id="recentActivity">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-history"></i> Recent Activity</h5>
        </div>
        <div class="card-body">
            <ul id="activityList" class="list-unstyled mb-0">
                <li class="text-muted"><i>No activity yet</i></li>
            </ul>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Confirm Stock Update
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>You are about to <span id="confirmMode">ADD</span> stock for:</strong></p>
                <ul>
                    <li><strong><span id="confirmItems">0</span></strong> products</li>
                    <li><strong><span id="confirmQuantity">0</span></strong> total items</li>
                </ul>
                <p class="mb-0">This action will update the inventory. Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmYesBtn">
                    <i class="fas fa-check"></i> Yes, Confirm
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Cancel Session
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Are you sure you want to cancel this session?</strong></p>
                <p class="mb-0 text-danger">
                    All scanned items (<span id="cancelItemCount">0</span>) will be lost.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Go Back</button>
                <button type="button" class="btn btn-danger" id="cancelYesBtn">
                    <i class="fas fa-times"></i> Yes, Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Camera Scanner Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title">
                    <i class="fas fa-camera"></i> Camera Scanner
                </h5>
                <div class="d-flex gap-2">
                    <!-- Flash/Torch Button -->
                    <button type="button" class="btn btn-outline-light btn-sm" id="toggleFlashBtn">
                        <i class="fas fa-bolt"></i>
                    </button>
                    <!-- Switch Camera Button -->
                    <button type="button" class="btn btn-outline-light btn-sm" id="switchCameraBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- Close Button -->
                    <button type="button" class="btn-close btn-close-white" id="closeCameraModalBtn"></button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-0 position-relative d-flex align-items-start justify-content-center">
                <!-- Camera Reader -->
                <div id="reader" style="width: 100%; height: 100%;"></div>

                <!-- Product Preview Overlay (Hidden by default) -->
                <div id="productOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column"
                    style="background: rgba(0,0,0,0.9); display: none !important; z-index: 1000;">

                    <!-- Top Section: Product Info ONLY -->
                    <div class="text-center text-white" style="padding: 30px 20px;">
                        <!-- Product Image -->
                        <div class="mb-3">
                            <img id="productImage" src="" alt="Product" class="img-thumbnail"
                                style="max-width: 200px; max-height: 200px; object-fit: cover; background: #f0f0f0;">
                        </div>

                        <!-- Product Info -->
                        <div class="mb-2" style="font-size: 1.2em;">
                            <p class="mb-2"><strong>Code:</strong> <span id="productCode">-</span></p>
                            <p class="mb-2"><strong>Color:</strong> <span id="productColor">-</span></p>
                            <p class="mb-0"><strong>Stock:</strong> <span id="productStock"
                                    class="badge bg-info">0</span></p>
                        </div>
                    </div>

                    <!-- Spacer to push bottom content down -->
                    <div style="flex: 1;"></div>

                    <!-- Bottom Section: Buttons ONLY (no padding-bottom to allow space for status) -->
                    <div class="text-center text-white" style="padding-bottom: 80px;">
                        <!-- Action Buttons Row -->
                        <div class="d-flex gap-3 justify-content-center align-items-center px-3">
                            <!-- NEXT Button (Green, Left) -->
                            <button type="button" class="btn btn-success btn-lg px-5" id="nextScanBtn"
                                style="min-width: 150px;">
                                <i class="fas fa-arrow-right"></i> NEXT
                            </button>

                            <!-- CLOSE Button (Red, Right) -->
                            <button type="button" class="btn btn-danger btn-lg px-5" id="closeOverlayBtn"
                                style="min-width: 150px;">
                                <i class="fas fa-times"></i> CLOSE
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Scanning Status (Above buttons, doesn't block clicks) -->
                <div class="position-absolute start-0 w-100 text-center"
                    style="bottom: 80px; z-index: 1100; pointer-events: none;">
                    <span id="scanStatus" class="badge bg-primary" style="font-size: 1em; padding: 10px 20px;">
                        <i class="fas fa-qrcode"></i> Ready to Scan
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HTML5 QR Code Library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    // Session data from server (Safe parsing)
    {% if active_session and active_session.exists %}
    let sessionActive = true;
    let sessionMode = '{{ active_session.mode }}';

    // ‚úÖ Parse items safely using JSON.parse()
    let sessionItems = [];
    try {
        const itemsJson = {{ active_session.itemsjson | tojson
    }};
    if (itemsJson && typeof itemsJson === 'string') {
        sessionItems = JSON.parse(itemsJson);
    } else if (Array.isArray(itemsJson)) {
        sessionItems = itemsJson;
    } else {
        sessionItems = [];
    }
    console.log('‚úÖ Loaded session items:', sessionItems);
    } catch (e) {
        console.error('‚ùå Error parsing session items:', e);
        sessionItems = [];
    }

    let html5QrCode = null;
    {% else %}
    let sessionActive = false;
    let sessionMode = 'add';
    let sessionItems = [];
    let html5QrCode = null;
    {% endif %}



    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîç DOMContentLoaded - sessionActive:', sessionActive);
        console.log('üîç DOMContentLoaded - sessionItems:', sessionItems);

        if (sessionActive) {
            loadSessionItems();
        }

        // Set mode indicator
        updateModeIndicator();
    });

    // Start Session
    document.getElementById('startSessionBtn')?.addEventListener('click', function () {
        const mode = document.querySelector('input[name="sessionMode"]:checked').value;

        fetch('/barcode/session/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);

                    // Reload page to refresh session data
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('error', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to start session');
            });
    });

    // Camera Scanner - New Modal Implementation
    let cameraModal = null;
    let currentFacingMode = "environment"; // "environment" = back camera, "user" = front camera
    let isFlashOn = false;
    let isCameraScanning = false; // Track if camera is actively scanning

    document.getElementById('startCameraBtn')?.addEventListener('click', async function () {
        try {
            // Request camera permission first
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: currentFacingMode }
            });

            // Stop the stream (we just needed permission)
            stream.getTracks().forEach(track => track.stop());

            // Show modal
            cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
            cameraModal.show();

            // Start camera after modal is shown
            document.getElementById('cameraModal').addEventListener('shown.bs.modal', function () {
                console.log('üì∑ Modal shown - clearing overlay and starting camera');
                // Ensure overlay is hidden (override !important)
                document.getElementById('productOverlay').style.setProperty('display', 'none', 'important');
                startCamera();
            }, { once: true });

        } catch (err) {
            console.error("Camera permission denied:", err);
            showToast('error', 'Camera access denied. Please allow camera in browser settings.');
        }
    });

    // Start Camera
    function startCamera() {
        if (html5QrCode) {
            html5QrCode.stop().catch(() => { });
        }

        html5QrCode = new Html5Qrcode("reader");
        isCameraScanning = true;

        // Update status
        document.getElementById('scanStatus').innerHTML = '<i class="fas fa-qrcode"></i> Scanning...';
        document.getElementById('scanStatus').className = 'badge bg-success';

        html5QrCode.start(
            { facingMode: currentFacingMode },
            {
                fps: 10,
                qrbox: { width: 350, height: 200 },  // Landscape guiding box
                aspectRatio: 16 / 9  // Landscape camera orientation
            },
            (decodedText) => {
                if (!isCameraScanning) return; // Ignore if paused

                // Pause scanning
                pauseCamera();

                // Process barcode
                let barcode = String(decodedText).trim();
                if (/^\d+$/.test(barcode) && barcode.length <= 13) {
                    barcode = barcode.padStart(13, '0');
                }

                console.log('Scanned barcode:', barcode);
                processScanInModal(barcode);
            },
            (errorMessage) => { /* Scanning... */ }
        ).catch(err => {
            console.error("Error starting camera:", err);
            showToast('error', 'Failed to start camera');
            if (cameraModal) cameraModal.hide();
        });

        // Flash button is now always visible, but check for torch support when clicked
    }

    // Pause Camera (stop scanning but keep stream)
    function pauseCamera() {
        isCameraScanning = false;
        document.getElementById('scanStatus').innerHTML = '<i class="fas fa-pause"></i> Paused';
        document.getElementById('scanStatus').className = 'badge bg-warning';
    }

    // Resume Camera (start scanning again)
    function resumeCamera() {
        console.log('‚ñ∂Ô∏è Resuming camera - clearing overlay');
        // Clear product overlay (override !important)
        document.getElementById('productOverlay').style.setProperty('display', 'none', 'important');
        document.getElementById('productCode').textContent = '-';
        document.getElementById('productColor').textContent = '-';
        document.getElementById('productStock').textContent = '0';
        document.getElementById('productImage').src = '';

        isCameraScanning = true;
        document.getElementById('scanStatus').innerHTML = '<i class="fas fa-qrcode"></i> Scanning...';
        document.getElementById('scanStatus').className = 'badge bg-success';
    }

    // Stop Camera
    function stopCamera() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
                isCameraScanning = false;

                // Clear product overlay state (override !important)
                document.getElementById('productOverlay').style.setProperty('display', 'none', 'important');
                document.getElementById('productCode').textContent = '-';
                document.getElementById('productColor').textContent = '-';
                document.getElementById('productStock').textContent = '0';
                document.getElementById('productImage').src = '';
                document.getElementById('scanStatus').innerHTML = '<i class="fas fa-qrcode"></i> Ready to Scan';
                document.getElementById('scanStatus').className = 'badge bg-primary';
            }).catch(err => {
                console.error('Error stopping camera:', err);
            });
        }
    }

    // Close Camera Modal
    document.getElementById('closeCameraModalBtn')?.addEventListener('click', function () {
        stopCamera();
        if (cameraModal) cameraModal.hide();
    });

    // Switch Camera (Front/Back)
    document.getElementById('switchCameraBtn')?.addEventListener('click', function () {
        currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
        stopCamera();
        setTimeout(() => startCamera(), 500);
    });

    // Toggle Flash/Torch (Mobile only)
    document.getElementById('toggleFlashBtn')?.addEventListener('click', async function () {
        try {
            const track = html5QrCode?.getRunningTrackCapabilities();
            if (track && track.torch) {
                isFlashOn = !isFlashOn;
                await track.applyConstraints({
                    advanced: [{ torch: isFlashOn }]
                });
                this.classList.toggle('btn-warning', isFlashOn);
            }
        } catch (err) {
            console.error('Flash not supported:', err);
            showToast('warning', 'Flash not supported on this device');
        }
    });

    // Process Scan in Modal (NO time-based duplicate prevention)
    function processScanInModal(barcode) {
        if (!sessionActive) {
            showToast('error', 'Please start a session first');
            playSound('error');
            resumeCamera();
            return;
        }

        // Send to server
        fetch('/barcode/session/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ barcode: barcode })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    playSound('success');

                    // Show product overlay
                    showProductOverlay(data.item);

                    // Add to session items
                    const variantId = data.item.variant_id;
                    const existingIndex = sessionItems.findIndex(item => item.variant_id === variantId);

                    if (existingIndex >= 0) {
                        sessionItems[existingIndex].quantity += 1;
                    } else {
                        sessionItems.push({
                            variant_id: data.item.variant_id,
                            product_code: data.item.productcode,
                            brand_name: data.item.brandname,
                            color_name: data.item.colorname,
                            current_stock: data.item.stockquantity,
                            image_url: data.item.imageurl,
                            quantity: 1
                        });
                    }

                    // Update UI
                    loadSessionItems();
                    addActivity(`Added ${data.item.productcode} - ${data.item.colorname}`, 'success');

                } else {
                    playSound('error');
                    showToast('error', data.error);
                    addActivity(data.error, 'error');
                    resumeCamera(); // Resume immediately on error
                }
            })
            .catch(error => {
                console.error('Error:', error);
                playSound('error');
                showToast('error', 'Failed to scan barcode');
                resumeCamera(); // Resume immediately on error
            });
    }

    // Show Product Overlay
    function showProductOverlay(item) {
        // Set product info
        document.getElementById('productCode').textContent = item.productcode || 'N/A';
        document.getElementById('productColor').textContent = item.colorname || 'N/A';
        document.getElementById('productStock').textContent = item.stockquantity || 0;

        // Set product image
        const imageUrl = item.imageurl || 'https://via.placeholder.com/150x150/f0f0f0/999999?text=No+Image';
        document.getElementById('productImage').src = imageUrl;
        document.getElementById('productImage').onerror = function () {
            this.src = 'https://via.placeholder.com/150x150/f0f0f0/999999?text=No+Image';
        };

        // Update scan status to Paused
        document.getElementById('scanStatus').innerHTML = '<i class="fas fa-pause"></i> Paused';
        document.getElementById('scanStatus').className = 'badge bg-warning';

        // Show overlay (override !important)
        document.getElementById('productOverlay').style.setProperty('display', 'flex', 'important');
    }

    // NEXT Button - Resume scanning
    document.getElementById('nextScanBtn')?.addEventListener('click', function () {
        resumeCamera();
    });

    // CLOSE Button - Close modal
    document.getElementById('closeOverlayBtn')?.addEventListener('click', function () {
        stopCamera();
        if (cameraModal) cameraModal.hide();
    });

    // Manual Scan Button
    document.getElementById('scanBtn')?.addEventListener('click', function () {
        const barcode = document.getElementById('barcodeInput').value.trim();
        if (barcode) {
            processScan(barcode);
        }
    });

    // Enter key for manual input
    document.getElementById('barcodeInput')?.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            const barcode = this.value.trim();
            if (barcode) {
                processScan(barcode);
            }
        }
    });


    // Process Scan (for manual/USB scanner - NO duplicate prevention)
    function processScan(barcode) {
        barcode = String(barcode).trim();

        // Pad EAN-13 barcodes
        if (/^\d+$/.test(barcode) && barcode.length > 0 && barcode.length <= 13) {
            barcode = barcode.padStart(13, '0');
        }

        console.log('Processing barcode:', barcode);

        if (!sessionActive) {
            showToast('error', 'Please start a session first');
            playSound('error');
            return;
        }

        // Send to server (NO time-based duplicate prevention)
        fetch('/barcode/session/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ barcode: barcode })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    playSound('success');
                    showToast('success', `‚úÖ ${data.item.productcode} - ${data.item.colorname}`);

                    // Add to session items
                    const variantId = data.item.variant_id;
                    const existingIndex = sessionItems.findIndex(item => item.variant_id === variantId);

                    if (existingIndex >= 0) {
                        // Item exists - increase quantity by 1
                        sessionItems[existingIndex].quantity += 1;
                    } else {
                        // New item - add with quantity 1
                        sessionItems.push({
                            variant_id: data.item.variant_id,
                            product_code: data.item.productcode,
                            brand_name: data.item.brandname,
                            color_name: data.item.colorname,
                            current_stock: data.item.stockquantity,
                            image_url: data.item.imageurl,
                            quantity: 1
                        });
                    }

                    // Update UI
                    loadSessionItems();
                    addActivity(`Added ${data.item.productcode} - ${data.item.colorname}`, 'success');

                    // Clear input
                    document.getElementById('barcodeInput').value = '';
                    // Only focus on desktop (not mobile)
                    if (!/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)) {
                        document.getElementById('barcodeInput').focus();
                    }
                } else {
                    playSound('error');
                    showToast('error', data.error);
                    addActivity(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                playSound('error');
                showToast('error', 'Failed to scan barcode');
            });
    }

    // Set quick quantity
    function setQuickQuantity(qty) {
        document.getElementById('quantityInput').value = qty;
    }

    // Confirm quantity and add to session
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('confirmQuantityBtn')?.addEventListener('click', function () {
            if (!pendingScanData) return;

            const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

            if (quantity < 1) {
                showToast('error', 'Quantity must be at least 1');
                return;
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
            modal.hide();

            // Add to session with quantity
            addItemToSession(pendingScanData, quantity);

            // Clear pending data
            pendingScanData = null;
        });

        // Enter key on quantity input
        document.getElementById('quantityInput')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('confirmQuantityBtn').click();
            }
        });
    });

    // Add item to session with quantity
    function addItemToSession(data, quantity) {
        playSound('success');
        showToast('success', `‚úÖ Added ${quantity}x ${data.item.productcode}`);

        // Update session items
        const variantId = data.item.variant_id;
        const existingIndex = sessionItems.findIndex(item => item.variant_id === variantId);

        if (existingIndex >= 0) {
            // Item exists - add quantity
            sessionItems[existingIndex].quantity += quantity;
        } else {
            // New item - add with quantity
            sessionItems.push({
                variant_id: data.item.variant_id,
                product_code: data.item.productcode,
                brand_name: data.item.brandname,
                color_name: data.item.colorname,
                current_stock: data.item.stockquantity,  // ‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ≥ÿ™ŸàŸÉ ÿßŸÑÿ≠ÿßŸÑŸä
                image_url: data.item.imageurl,
                quantity: quantity
            });
        }

        // Update session in DB
        updateSessionInDB();

        // Update UI
        loadSessionItems();
        addActivity(`Added ${quantity}x ${data.item.productcode} - ${data.item.colorname}`, 'success');

        // Clear input
        document.getElementById('barcodeInput').value = '';
        // Only focus on desktop (not mobile)
        if (!/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)) {
            document.getElementById('barcodeInput').focus();
        }
    }

    // Update session in database
    // Update session in database
    function updateSessionInDB() {
        // Convert to simple format (only variant_id + quantity)
        const simpleItems = sessionItems.map(item => ({
            variant_id: item.variant_id,
            quantity: item.quantity
        }));

        fetch('/barcode/session/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: simpleItems })
        })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update session:', data.error);
                }
            })
            .catch(error => console.error('Error updating session:', error));
    }

    // Load Session Items
    function loadSessionItems() {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';

        if (sessionItems.length === 0) {
            document.getElementById('itemsSection').classList.add('d-none');
            return;
        }

        document.getElementById('itemsSection').classList.remove('d-none');

        sessionItems.forEach((item, index) => {
            let imageUrl = item.image_url || 'https://via.placeholder.com/100x100/f0f0f0/999999?text=No+Image';

            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${index + 1}</td>
            <td> <a href="${imageUrl}" target="_blank" rel="noopener noreferrer"> <img src="${imageUrl}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover; background: #f0f0f0" onerror="this.onerror=null; this.src='https://via.placeholder.com/100x100/f0f0f0/999999?text=No+Image'"></td>
            <td><strong>${item.product_code || 'N/A'}</strong></td>
            <td>${item.brand_name || 'N/A'}</td>
            
            <!-- ‚úÖ Quantity moved here (before Color) -->
            <td>
                <div class="input-group input-group-sm" style="min-width: 100px; max-width: 180px;">
                    <button class="btn btn-outline-secondary" onclick="changeQuantity(${item.variant_id}, -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" 
                        class="form-control text-center" 
                        value="${item.quantity || 1}" 
                        min="1" 
                        onchange="updateQuantity(${item.variant_id}, this.value)"
                        style="font-weight: bold;">
                    <button class="btn btn-outline-secondary" onclick="changeQuantity(${item.variant_id}, 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </td>
            
            <td>${item.color_name || 'N/A'}</td>
            <td><span class="badge bg-info">${item.current_stock || 0}</span></td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="removeItem(${item.variant_id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });

        updateSummary();
    }

    // Change quantity (+/-)
    function changeQuantity(variantId, change) {
        const item = sessionItems.find(item => item.variant_id === variantId);
        if (item) {
            item.quantity = Math.max(1, item.quantity + change);
            loadSessionItems();
        }
    }

    // Update quantity manually
    function updateQuantity(variantId, newValue) {
        const item = sessionItems.find(item => item.variant_id === variantId);
        if (item) {
            const qty = parseInt(newValue) || 1;
            item.quantity = Math.max(1, qty);
            loadSessionItems();
        }
    }

    // Remove Item
    function removeItem(variantId) {
        if (!confirm('Remove this item from session?')) return;

        fetch('/barcode/session/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ variant_id: variantId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    sessionItems = sessionItems.filter(i => i.variant_id !== variantId);
                    loadSessionItems();
                } else {
                    showToast('error', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to remove item');
            });
    }

    // Clear All
    document.getElementById('clearBtn')?.addEventListener('click', function () {
        if (!confirm('Clear all items from session?')) return;

        fetch('/barcode/session/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    sessionItems = [];
                    loadSessionItems();
                } else {
                    showToast('error', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to clear session');
            });
    });

    // Confirm Session
    document.getElementById('confirmBtn')?.addEventListener('click', function () {
        if (sessionItems.length === 0) {
            showToast('warning', 'Session is empty');
            return;
        }

        document.getElementById('confirmMode').textContent = sessionMode.toUpperCase();
        document.getElementById('confirmItems').textContent = sessionItems.length;
        document.getElementById('confirmQuantity').textContent = sessionItems.reduce((sum, item) => sum + item.quantity, 0);

        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    });

    document.getElementById('confirmYesBtn')?.addEventListener('click', function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        if (modal) modal.hide();

        console.log('‚úÖ Confirm button clicked');

        // Step 1: Save quantities first
        const simpleItems = sessionItems.map(item => ({
            variant_id: item.variant_id,
            quantity: item.quantity
        }));

        console.log('Saving items:', simpleItems);

        fetch('/barcode/session/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: simpleItems })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Update response:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Failed to update session');
                }

                // Step 2: Confirm session (update stock)
                console.log('Confirming session...');
                return fetch('/barcode/session/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            })
            .then(response => response.json())
            .then(data => {
                console.log('Confirm response:', data);

                if (data.success) {
                    playSound('success');
                    showToast('success', `‚úÖ ${data.message} - Updated ${data.updated_count} items`);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    playSound('error');
                    showToast('error', data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Error:', error);
                playSound('error');
                showToast('error', error.message || 'Failed to confirm session');
            });
    });

    // Cancel Session
    document.getElementById('cancelBtn')?.addEventListener('click', function () {
        document.getElementById('cancelItemCount').textContent = sessionItems.length;
        const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
        modal.show();
    });

    document.getElementById('cancelYesBtn')?.addEventListener('click', function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelModal'));
        modal.hide();

        fetch('/barcode/session/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('error', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to cancel session');
            });
    });

    // Update Summary
    function updateSummary() {
        const totalItems = sessionItems.length;
        const totalQuantity = sessionItems.reduce((sum, item) => sum + item.quantity, 0);

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('totalQuantity').textContent = totalQuantity;
    }

    // Update Mode Indicator
    function updateModeIndicator() {
        const indicator = document.getElementById('sessionModeIndicator');
        if (indicator) {
            indicator.textContent = sessionMode.toUpperCase() + ' MODE';
            indicator.className = 'badge bg-' + (sessionMode === 'add' ? 'success' : 'danger');
        }
    }

    // Add Activity
    function addActivity(message, type) {
        const list = document.getElementById('activityList');

        // Remove "no activity" message if exists
        const noActivityMsg = list.querySelector('.text-muted');
        if (noActivityMsg) {
            noActivityMsg.remove();
        }

        const now = new Date().toLocaleTimeString();

        const item = document.createElement('li');
        item.className = 'mb-2';
        item.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle text-success' : 'times-circle text-danger'}"></i>
        ${message} <small class="text-muted">(${now})</small>
    `;

        list.prepend(item);

        // Keep only last 5 activities
        while (list.children.length > 5) {
            list.removeChild(list.lastChild);
        }
    }

    // Play Sound (Web Audio API - no files needed)
    function playSound(type) {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'success') {
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
            } else {
                oscillator.frequency.value = 300;
                oscillator.type = 'square';
            }

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (e) {
            console.log('Could not play sound:', e);
        }
    }

    // Toast Notifications
    function showToast(type, message) {
        const colors = {
            success: '#28a745',
            error: '#dc3545',
            warning: '#ffc107',
            info: '#17a2b8'
        };

        const toast = document.createElement('div');
        toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    #reader {
        border: 2px solid #007bff;
        border-radius: 10px;
    }

    /* Hide default number input arrows (spinners) */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type="number"] {
        -moz-appearance: textfield;
        /* Firefox */
        appearance: textfield;
    }
</style>

{% endblock %}